<!DOCTYPE html>
<html>
  <body>
    <h3>Offline Audio Transcriber</h3>

    <p>
      Output language:
      <select id="myOutputLang">
        <option value="en">English</option>
        <option value="es">Spanish</option>
        <option value="ja">Japanese</option>
      </select>
    </p>

    <div id="myStatus">Checking model availability…</div>
    <br>

    <input type="button" value="Start Recording" onclick="myStartRecording()">
    <input type="button" value="Stop Recording" onclick="myStopRecording()">
    <br><br>

    <input type="file" id="myFileInput" accept="audio/*" onchange="myHandleFile(this)">
    <br><br>

    <p><b>Transcription:</b></p>
    <pre id="myOutput"></pre>

    <script>
      let myRecorder, myChunks = [], myStream, mySession;
      let myReady = false;

      async function myCheckModel() {
        const status = document.getElementById("myStatus");
        let availability = await LanguageModel.availability();
        if (availability === "downloadable") {
          status.textContent = "Model downloadable. Downloading…";
          await LanguageModel.download();
        }
        let check = setInterval(async () => {
          let a = await LanguageModel.availability();
          if (a === "available") {
            clearInterval(check);
            status.textContent = "Model ready.";
            myReady = true;
          }
        }, 1000);
      }

      async function myEnsureSession() {
        const lang = document.getElementById("myOutputLang").value;
        if (!mySession || mySession.outputLanguage !== lang) {
          mySession = await LanguageModel.create({
            outputLanguage: lang,
            initialPrompts: [
              { role: "system", content: "You are a speech-to-text transcriber." }
            ]
          });
        }
        return mySession;
      }

      async function myStartRecording() {
        if (!myReady) {
          document.getElementById("myStatus").textContent = "Model not ready yet.";
          return;
        }
        myStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        myRecorder = new MediaRecorder(myStream);
        myRecorder.ondataavailable = e => myChunks.push(e.data);

        myRecorder.onstop = async () => {
          const blob = new Blob(myChunks, { type: "audio/webm" });
          myChunks = [];
          await myProcessAudioBlob(blob);
        };

        myRecorder.start();
        document.getElementById("myStatus").textContent = "Recording…";
      }

      function myStopRecording() {
        if (myRecorder && myRecorder.state === "recording") {
          myRecorder.stop();
          myStream.getTracks().forEach(track => track.stop());
          document.getElementById("myStatus").textContent = "Processing transcription…";
        }
      }

      async function myHandleFile(input) {
        const file = input.files[0];
        if (!file) return;
        document.getElementById("myStatus").textContent = "Processing file…";
        await myProcessAudioBlob(file);
      }

      async function myProcessAudioBlob(blob) {
        const arrayBuffer = await blob.arrayBuffer();

        const session = await myEnsureSession();
        const stream = session.promptStreaming([
          {
            role: "user",
            content: [
              { type: "text", value: "Please transcribe this audio file." },
              { type: "audio", value: arrayBuffer }
            ]
          }
        ]);

        let text = "";
        for await (const chunk of stream) {
          if (chunk?.output?.[0]?.content?.[0]?.text) {
            text += chunk.output[0].content[0].text;
            document.getElementById("myOutput").textContent = text;
          }
        }

        document.getElementById("myStatus").textContent = "Transcription complete.";
      }

      // Run check on load
      myCheckModel();
    </script>
  </body>
</html>
